{% extends "base.html" %}

{% block title %}{{ episode.title or 'Episode Details' }}{% endblock %}

{% block content %}
    <section class="episode-detail">
        <a href="{{ url_for('index') }}" class="back-link">&larr; Back to Dashboard</a>
        
        <div class="episode-header">
            <h2>{{ episode.title }}</h2>
            <div class="episode-actions">
                {% if episode.status == 'completed' %}
                    <form action="{{ url_for('summarize_again', episode_id=episode._id) }}" method="POST" style="display: inline;">
                        <button type="submit" class="button primary" onclick="return confirm('This will re-run cleaning and summarization with the new prompts. Continue?')">
                            ðŸ”„ Summarize Again
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
        <p><strong>Status:</strong> <span class="status-badge status-{{ episode.status }}">{{ episode.status }}</span></p>
        <p><strong>URL:</strong> <a href="{{ episode.url }}" target="_blank">{{ episode.url }}</a></p>
        <p><strong>Submitted:</strong> {{ episode.created_at.strftime('%Y-%m-%d %H:%M') }} UTC</p>

        {% if episode.status == 'completed' %}
            
            {% if episode.get('file_path') %}
            <div class="audio-player">
                <h3>Audio{% if episode.get("duration") %} <span style="font-size: 0.8em; color: #666;">({{ (episode.duration // 60) }}:{{ "%02d" % (episode.duration % 60) }})</span>{% endif %}</h3>
                <audio controls>
                    <source src="/data/{{ episode.file_path }}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </div>
            {% endif %}

            <div class="summary">
                <h3>Summary</h3>
                <div class="markdown-content">{{ episode.summary | markdown | safe }}</div>
            </div>

            <div class="transcript-accordion">
                <button class="accordion-toggle" onclick="toggleTranscript()">
                    <h3>Transcript</h3>
                    <span class="accordion-icon">â–¼</span>
                </button>
                <div class="accordion-content" id="transcript-content">
                    <p>{{ episode.transcript }}</p>
                </div>
            </div>

        {% elif episode.status == 'failed' %}
            <div class="error-message">
                <h3>Processing Failed</h3>
                <p><strong>Error:</strong> {{ episode.error_message }}</p>
            </div>
        {% else %}
            <p>This episode is currently being processed. Please check back later.</p>
        {% endif %}

    </section>

    <script>
        function toggleTranscript() {
            const content = document.getElementById('transcript-content');
            const icon = document.querySelector('.accordion-icon');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.textContent = 'â–²';
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¼';
            }
        }
        
        // Initialize accordion as collapsed
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('transcript-content').style.display = 'none';
        });
    </script>
{% endblock %}
